{% extends "base.html" %}

{% load static %}

{% block css_files %}


<link rel="stylesheet" href="{% static 'bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'base.css' %}">


<link rel="stylesheet" href="{% static 'home.css' %}">
{% endblock %}

{% block content %}

<div class="container" id="home_body">
	<div  id="filters">
		<div class="mt-3">
			<div class="mb-3">

				<input type="text" class="form-control" id="search_input" placeholder="Search" aria-describedby="text">
				
			</div>

		</div>
		<div>
			<div>
				<select class="form-select" id="sort_select" aria-label="Default select example">
					<option >Sort by</option>
					<option value="name">Name</option>
					<option value="bugs_count">Bugs</option>
					<option value="date_added">Date added</option>
				</select>
			</div>
		</div>
		
	</div>
	<div id="results">
		<table class="table">
			<thead>
				<tr>
					<th scope="col">#</th>
					<th scope="col">Title</th>
					<th scope="col">Bugs</th>
					<th scope="col">Date</th>
				</tr>
			</thead>
			<tbody id="table_body">
				{% for project in projects %}

				<tr>
					<th scope="row"> {{ forloop.counter }}</th>
					<td><a href="{% url 'home' %}/{{project.id}}" class="a_color">{{ project.name }}</a></td>
					<td>{{ project.bugs_count }}</td>
					<td>{{ project.date_added }}</td>
					<td><button class="remove_project" id="{{ project.id }}" >Remove</button></td>
				</tr>

				{% endfor %}

			</tbody>
		</table>	
	
			<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" id="add_project" data-bs-toggle="modal" data-bs-target="#exampleModal">
  Add project
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">New Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form>
      	<div class="form-group">
      		<label for="exampleInputEmail1">Name</label>
      		<input type="email" class="form-control" id="new_project_name" aria-describedby="emailHelp" >
      		
      	</div>
      	
      	
      	
      </form>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="save_changes" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

	
		{% if not projects %}
		<div id="no_results_found">no results found</div>
		{% endif %}
	</div>
</div>


<script src="{% static 'JS/jquery.js' %}"></script>
<script src="{% static 'JS/home-js.js' %}"></script>
<script >

  let select =$("#sort_select")


  select.change(function ()
  {
    var method = $("#sort_select").val()
    if (method == "Sort by")return 
    $.ajax(
    {
      url: "{% url 'home' %}",
      type:'GET',

      headers: {"method": method , "ajax":true , "ajaxFunction":"sort"},
      success:function(data)
      {
        
       wrapper = json_to_html(data)

        document.getElementById("table_body").innerHTML =wrapper
         if(wrapper === "")
        {
          document.getElementById("table_body").innerHTML = "no result found"
        }
        enable_delete()

      }
    })
  })

  //search ajax
  let search = $("#search_input")
  search.on('input', function() 
  {
  	var value = search.val()
  	$.ajax(
  	{
  		url:"{% url 'home' %}",
  		type:"GET",
  		headers:{"searchWord":value , "ajax":true , "ajaxFunction":"search" },
  		success :function (data)
  		{
  			 wrapper = json_to_html(data)
  			 document.getElementById("table_body").innerHTML =wrapper
       		  if(wrapper === "")
        		{	
         		 document.getElementById("table_body").innerHTML = "no result found"
        		}
        		enable_delete()
  		}
  	})
  })


 function json_to_html(json_data)
 {
 	try
 	{
 		json_data = JSON.parse(json_data)
 	}catch
 	{
 		return ""
 	}
 	list = []
 	for(let i = 0 ; i< json_data.length ; i++)
 	{
 		list[i] = JSON.parse(json_data[i])
 	}
 	wrapper = ``
 	counter = 1
 	list.forEach((x)=>
 	{
 		wrapper +=`
          <tr>
          <th scope="row"> ${ counter }</th>
          <td ><a href="{% url 'home' %}/${x.id}" class="a_color">${x.name}</a></td>
          <td >${x.bugs_count}</td>
          <td >${x.date}</td>
          <td><button class="remove_project" id="${x.id}" >Remove</button></td>
          </tr> 
          `
          counter ++
 	})

 	return wrapper	
 }


$("#add_project").click(function (){
	send_project()
})

 function send_project()
 {
 	$("#save_changes").click(function ()
 	{
 		name = $("#new_project_name").val()

 		if(name == "")
 		{
 			window.alert("Project title is required");
 		}else
 		{

let project_name = name 


$.ajax(
  	{
  		url:"{% url 'home' %}",
  		type:"GET",
  		headers:{"data":project_name , "ajax":true , "ajaxFunction":"add" },
  		success :function (data)
  		{
  			$("#new_project_name").val("")
  			wrapper = json_to_html(data)
  			 document.getElementById("table_body").innerHTML =wrapper
       		  if(wrapper === "")
        		{	
         		 document.getElementById("table_body").innerHTML = "no result found"
        		}
        		enable_delete()
  		}
  	})
}
 	})
 }
enable_delete()
function enable_delete()
{
	col = document.getElementsByClassName("remove_project")
	for(let i = 0 ; i < col.length ; i++)
	{
		
		
		
		col[i].addEventListener("click" , function (event)
		{
			to_send = event.target.id
			$.ajax( 
			{
				url : "{% url 'home' %}",
				type :"GET",
				headers:{"data":to_send , "ajax":true , "ajaxFunction":"delete" },
				success : function (data){
					wrapper = json_to_html(data)
  			 document.getElementById("table_body").innerHTML =wrapper
       		  if(wrapper === "")
        		{	
         		 document.getElementById("table_body").innerHTML = "no result found"
        		}
        		enable_delete()
				}
			})
		})
	}
}



</script>

{% endblock %}
